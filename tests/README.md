# Test Scripts

This folder contains various test and diagnostic scripts for the Discord Maid Bot.

## Quick Start

Run all tests:
```bash
npm test
```

Run specific test suite:
```bash
npm run test:db          # Database tests
npm run test:network     # Network scanner tests
npm run test:ha          # Home Assistant tests
npm run test:esp         # ESP device detection
```

## Unit Tests

### test-database.js
Database operations and performance tests.

**Usage:**
```bash
npm run test:db
# or
node tests/test-database.js
```

**What it does:**
- Creates a separate test database
- Inserts test fixtures (devices, speed tests, research, etc.)
- Runs queries to verify data integrity
- Tests performance with bulk inserts
- Validates all database operations

**Test Coverage:**
- Device management (CRUD operations)
- Speed test logging
- Research history
- Chat history
- Scheduled tasks
- Configuration storage
- Performance benchmarks

### test-network-scanner.js
Network scanner logic and device detection tests.

**Usage:**
```bash
npm run test:network
# or
node tests/test-network-scanner.js
```

**What it does:**
- Tests device grouping by network type
- Validates MAC and IP addresses
- Tests device naming functionality
- Compares quick ping vs full scan performance
- Tests device state transitions
- Validates network type detection
- Tests search and filter functionality

**Test Coverage:**
- Device grouping (local/Tailscale)
- MAC address validation
- IP address validation
- Quick ping performance
- State management
- Search functionality

## Integration Tests

## Home Assistant Tests

### test-homeassistant.js
Basic Home Assistant troubleshooting script.

**Usage:**
```bash
node tests/test-homeassistant.js
```

**What it does:**
- Tests basic connection to Home Assistant
- Lists all entities by domain
- Searches for ESP devices using multiple methods
- Provides recommendations for setup

### test-homeassistant-detailed.js
Comprehensive Home Assistant analysis.

**Usage:**
```bash
node tests/test-homeassistant-detailed.js
```

**What it does:**
- Checks all IoT integrations (ESPHome, MQTT, Tasmota, Zigbee, Z-Wave, etc.)
- Analyzes network devices
- Generates detailed report file (`ha-analysis-report.txt`)
- Provides step-by-step setup guides for ESP devices

### test-ha-deep-dive.js
Deep dive analysis of Home Assistant entities.

**Usage:**
```bash
node tests/test-ha-deep-dive.js
```

**What it does:**
- Fetches ALL entities with full details
- Saves complete entity dump to JSON
- Analyzes entities for ESP/ESPHome indicators
- Checks specific domains (lights, switches, sensors, etc.)
- Attempts to access ESPHome dashboard

**Output files:**
- `ha-entities-full-dump.json` - Complete entity data
- `ha-esp-devices.json` - Filtered ESP devices

### test-esp-detection.js
Tests the bot's ESP device detection functionality.

**Usage:**
```bash
node tests/test-esp-detection.js
```

**What it does:**
- Initializes Home Assistant connection
- Tests the `getESPDevices()` function
- Shows detected devices with online/offline status
- Displays all entities for each device

## Utility Scripts

### find-controllers.cjs
CommonJS script to find controller/PC entities in Home Assistant.

**Usage:**
```bash
node tests/find-controllers.cjs
```

**What it does:**
- Reads `ha-entities-full-dump.json`
- Filters entities containing 'controller', 'kusanagi', 'madara', or 'pc_'
- Displays detailed information about each entity

## Output Files

### ha-analysis-report.txt
Generated by `test-homeassistant-detailed.js`. Contains:
- Connection status
- Integration status
- Entity summary
- Diagnosis and recommendations

### ha-entities-full-dump.json
Generated by `test-ha-deep-dive.js`. Contains:
- Complete dump of all Home Assistant entities
- Full attributes for each entity

### ha-esp-devices.json
Generated by `test-ha-deep-dive.js`. Contains:
- Filtered list of entities with ESP indicators
- Detailed analysis of potential ESP devices

## Running Tests on Server

To run tests on the production server:

```bash
# SSH into server
ssh think@192.168.0.250

# Navigate to bot directory
cd ~/discord-maid-bot

# Load Node.js
source ~/.nvm/nvm.sh && nvm use 20

# Run any test
node tests/test-homeassistant.js
node tests/test-esp-detection.js
```

## Requirements

All tests require:
- Node.js v20+
- `.env` file with `HA_URL` and `HA_TOKEN` configured
- Network access to Home Assistant instance

## Troubleshooting

If tests fail:
1. Check `.env` file has correct `HA_URL` and `HA_TOKEN`
2. Verify Home Assistant is accessible at the configured URL
3. Ensure the token has proper permissions
4. Check network connectivity

## Adding New Tests

When adding new test scripts:
1. Place them in this `tests/` folder
2. Use descriptive names starting with `test-`
3. Add documentation to this README
4. Include error handling and clear output
